---
# Phase 2: Lambdaé–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤
# 4ã¤ã®Lambdaé–¢æ•°ã‚’é †æ¬¡ãƒ‡ãƒ—ãƒ­ã‚¤

- name: Lambda Functions Deployment
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    env_name: "dev"
    aws_region: "ap-northeast-1"
    project_root: "{{ playbook_dir }}/../.."
    
  tasks:
    - name: "ðŸ“¦ Starting Lambda Functions Deployment"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    Lambda Functions                          â•‘
          â•‘                     Deployment                               â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Deploy RSS Monitor Lambda
      include_role:
        name: lambda-deployment
      vars:
        lambda_name: "rss-monitor-lambda"
        lambda_source_dir: "{{ project_root }}/src/lambda/rss_monitor"
        lambda_environment: "{{ env_name }}"

    - name: "âœ… RSS Monitor Lambda deployed"
      debug:
        msg: "âœ… RSS Monitor Lambda function deployed successfully"

    - name: Deploy Stream Status Checker Lambda
      include_role:
        name: lambda-deployment
      vars:
        lambda_name: "stream-status-checker-lambda"
        lambda_source_dir: "{{ project_root }}/src/lambda/stream_status_checker"
        lambda_environment: "{{ env_name }}"

    - name: "âœ… Stream Status Checker Lambda deployed"
      debug:
        msg: "âœ… Stream Status Checker Lambda function deployed successfully"

    - name: Deploy ECS Task Launcher Lambda
      include_role:
        name: lambda-deployment
      vars:
        lambda_name: "ecs-task-launcher-lambda"
        lambda_source_dir: "{{ project_root }}/src/lambda/ecs_task_launcher"
        lambda_environment: "{{ env_name }}"

    - name: "âœ… ECS Task Launcher Lambda deployed"
      debug:
        msg: "âœ… ECS Task Launcher Lambda function deployed successfully"

    - name: Deploy API Handler Lambda
      include_role:
        name: lambda-deployment
      vars:
        lambda_name: "api-handler-lambda"
        lambda_source_dir: "{{ project_root }}/src/lambda/api_handler"
        lambda_environment: "{{ env_name }}"

    - name: "âœ… API Handler Lambda deployed"
      debug:
        msg: "âœ… API Handler Lambda function deployed successfully"

    - name: Verify Lambda functions deployment
      command: >
        aws lambda list-functions 
        --query 'Functions[?starts_with(FunctionName, `{{ env_name }}-`)].{Name:FunctionName,Runtime:Runtime,LastModified:LastModified}'
        --output table
      register: lambda_list
      changed_when: false

    - name: "âœ… Lambda Functions Deployment Completed"
      debug:
        msg: |
          ðŸŽ‰ Lambda Functions Deployment Summary:
          âœ… RSS Monitor Lambda: Deployed (YouTube RSS monitoring)
          âœ… Stream Status Checker Lambda: Deployed (Live stream status checking)
          âœ… ECS Task Launcher Lambda: Deployed (Comment collection task control)
          âœ… API Handler Lambda: Deployed (REST API endpoints)
          
          ðŸ“Š Total Lambda Functions: 4
          
          ðŸ“‹ Deployed Functions:
          {{ lambda_list.stdout }}
